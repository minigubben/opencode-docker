x-opencode-common: &opencode-common
  build:
    context: .
    dockerfile: Dockerfile
    args:
      OPENCODE_NPM_PACKAGE: ${OPENCODE_NPM_PACKAGE:-opencode-ai}
      OPENCODE_NPM_VERSION: ${OPENCODE_NPM_VERSION:-latest}
      OPENCODE_EXTRA_NPM_PACKAGES: ${OPENCODE_EXTRA_NPM_PACKAGES:-}
      OPENCODE_EXTRA_APT_PACKAGES: ${OPENCODE_EXTRA_APT_PACKAGES:-}
  image: opencode:local
  env_file:
    - .env
  environment:
    TZ: ${TZ:-UTC}
    OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
    GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
    OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
    GITHUB_TOKEN: ${GITHUB_TOKEN:-}
    OPENCODE_MODEL: ${OPENCODE_MODEL:-}
  user: "1000:1000"
  working_dir: /home/node/allowed
  volumes:
    - ${HOST_ALLOWED_PATH:-./allowed}:/home/node/allowed
    - ./opencode-config:/home/node/.config/opencode
    - ./opencode-data:/home/node/.local/share/opencode
    - ./opencode-state:/home/node/.local/state/opencode

services:
  opencode-cli:
    <<: *opencode-common
    stdin_open: true
    tty: true
    command: ["."]

  opencode-web:
    <<: *opencode-common
    command:
      - web
      - --hostname
      - 0.0.0.0
      - --port
      - ${PORT:-4096}
  auth-proxy:
    build:
      context: ./proxy
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      PORT: ${PORT:-4096}
      UPSTREAM_URL: http://opencode-web:${PORT:-4096}
      AUTH_PASSWORD: ${AUTH_PASSWORD:-}
      AUTH_COOKIE_SECRET: ${AUTH_COOKIE_SECRET:-}
      AUTH_SESSION_TTL_HOURS: ${AUTH_SESSION_TTL_HOURS:-24}
      AUTH_SECURE_COOKIE: ${AUTH_SECURE_COOKIE:-false}
    depends_on:
      - opencode-web
    ports:
      - "${PORT:-4096}:${PORT:-4096}"
